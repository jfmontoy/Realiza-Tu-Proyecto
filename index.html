<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrador de Inventario AV (Local)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background-color: #f0f2f5; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        h1, h2 { color: #2c3e50; }
        .header-actions { margin-bottom: 20px; padding: 20px; background: #e3f2fd; border-radius: 8px; border: 1px solid #bbdefb; }
        
        /* Estilos del Formulario */
        .editor-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; background: #fff3e0; border: 1px solid #ffe0b2; border-radius: 8px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: bold; font-size: 12px; margin-bottom: 5px; color: #e65100; }
        input, select, textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        textarea { resize: vertical; height: 38px; }
        
        /* Botones */
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-right: 10px; }
        .btn-save { background-color: #2ecc71; color: white; }
        .btn-add { background-color: #3498db; color: white; width: 100%; margin-top: 10px; }
        .btn-download { background-color: #9b59b6; color: white; }
        .btn:hover { opacity: 0.9; }

        /* Tabla */
        .table-container { overflow-x: auto; max-height: 500px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #2c3e50; color: white; position: sticky; top: 0; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f1f1f1; }
        
        .action-btn { cursor: pointer; font-weight: bold; border: none; background: none; margin: 0 5px; font-size: 16px; }
        .delete-btn { color: red; }
        .duplicate-btn { color: #2980b9; }

        .project-section-title { grid-column: 1 / -1; margin-top: 20px; margin-bottom: 5px; color: #16a085; font-size: 16px;}
    </style>
</head>
<body>

<div class="container">
    <h1>üõ†Ô∏è Administrador de Productos (Modo Local)</h1>
    
    <div class="header-actions">
        <h3>1. Cargar Archivo CSV Existente</h3>
        <input type="file" id="csvFileInput" accept=".csv">
        <p style="font-size: 12px; color: #666;">Selecciona el archivo 'productos.csv' que descargaste de Google Sheets o tu copia local.</p>
    </div>

    <div id="workspace" style="display:none;">
        <h3>2. Agregar Nuevo Producto</h3>
        <form id="addForm">
            <h4>Detalles B√°sicos y Requerimientos</h4>
            <div class="editor-box">
                <div class="form-group"><label>ID √önico</label><input type="text" id="id" placeholder="N√∫mero de Ubicaci√≥n" required></div>
                <div class="form-group"><label>Categor√≠a</label><input type="text" id="cat1" placeholder="Ej: Audio"></div>
                <div class="form-group"><label>Producto</label><input type="text" id="cat2" placeholder="Ej: 01. Micr√≥fono"></div>
                <div class="form-group"><label>Nombre Imagen</label><input type="text" id="img" placeholder="foto-producto.png"></div>
                <div class="form-group"><label>Marca</label><input type="text" id="marca" placeholder="Bosch"></div>
                <div class="form-group"><label>Modelo</label><input type="text" id="modelo" required></div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="desc"></textarea></div>
                <div class="form-group"><label>Uso</label><textarea id="uso"></textarea></div>
                <div class="form-group"><label>EVAC (1=Si, Vacio=No)</label><input type="number" id="evac" max="1" min="" placeholder="1"></div>
                <div class="form-group"><label>Accesorio</label><input type="text" id="accesorio"></div>
                <div class="form-group"><label>Power Supply</label><input type="text" id="power"></div>
                <div class="form-group"><label>Tapa</label><input type="text" id="tapa"></div>
                <div class="form-group"><label>Caja</label><input type="text" id="caja"></div>
            </div>

            <h4>Aplicabilidad por Proyecto y Ubicaci√≥n (Marcar '1' o dejar vac√≠o)</h4>
            <div class="editor-box">
                <div class="project-section-title">Oficinas / Salas de Juntas</div>
                <div class="form-group"><label>HomeOf</label><input type="number" id="f_HomeOf" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Huddle</label><input type="number" id="f_Huddle" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Juntas</label><input type="number" id="f_Juntas" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Audit</label><input type="number" id="f_Audit" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Multi</label><input type="number" id="f_Multi" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Congr</label><input type="number" id="f_Congr" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Conv</label><input type="number" id="f_Conv" max="1" min="" placeholder="1=Aplica"></div>
                
                <div class="project-section-title">Retail / Restaurantes / Entretenimiento</div>
                <div class="form-group"><label>Rest</label><input type="number" id="f_Rest" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>RstBar</label><input type="number" id="f_RstBar" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>BarLoung</label><input type="number" id="f_BarLoung" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>BarMusic</label><input type="number" id="f_BarMusic" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Disco</label><input type="number" id="f_Disco" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Teatro</label><input type="number" id="f_Teatro" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Concert</label><input type="number" id="f_Concert" max="1" min="" placeholder="1=Aplica"></div>
                
                <div class="project-section-title">Residencial / Tiendas / Centros Comerciales</div>
                <div class="form-group"><label>Portatil</label><input type="number" id="f_Portatil" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Hi-End</label><input type="number" id="f_HiEnd" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>HomeTh</label><input type="number" id="f_HomeTh" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Apto</label><input type="number" id="f_Apto" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Casa</label><input type="number" id="f_Casa" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Tienda</label><input type="number" id="f_Tienda" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Market</label><input type="number" id="f_Market" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Mall</label><input type="number" id="f_Mall" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>CenCom</label><input type="number" id="f_CenCom" max="1" min="" placeholder="1=Aplica"></div>
                
                <div class="project-section-title">Hoteler√≠a / Museos / Parques</div>
                <div class="form-group"><label>Hotel</label><input type="number" id="f_Hotel" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Resort</label><input type="number" id="f_Resort" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Museo</label><input type="number" id="f_Museo" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Parque</label><input type="number" id="f_Parque" max="1" min="" placeholder="1=Aplica"></div>

                <div class="project-section-title">Educaci√≥n / Religi√≥n / Deporte</div>
                <div class="form-group"><label>EduDist</label><input type="number" id="f_EduDist" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Salon</label><input type="number" id="f_Salon" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Escuela</label><input type="number" id="f_Escuela" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Colegio</label><input type="number" id="f_Colegio" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Campus</label><input type="number" id="f_Campus" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Bibilotec</label><input type="number" id="f_Bibilotec" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Capilla</label><input type="number" id="f_Capilla" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Iglesia</label><input type="number" id="f_Iglesia" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Basilica</label><input type="number" id="f_Basilica" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>CasaOra</label><input type="number" id="f_CasaOra" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>centroOra</label><input type="number" id="f_centroOra" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Gym</label><input type="number" id="f_Gym" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Coliseo</label><input type="number" id="f_Coliseo" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Estadio</label><input type="number" id="f_Estadio" max="1" min="" placeholder="1=Aplica"></div>

                <div class="project-section-title">Salud / Industria / Gobierno / Transporte</div>
                <div class="form-group"><label>Consult</label><input type="number" id="f_Consult" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Clinica</label><input type="number" id="f_Clinica" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Hospital</label><input type="number" id="f_Hospital" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Bodega</label><input type="number" id="f_Bodega" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Fabrica</label><input type="number" id="f_Fabrica" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Complex</label><input type="number" id="f_Complex" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>EdificioOf</label><input type="number" id="f_EdificioOf" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>AeroReg</label><input type="number" id="f_AeroReg" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>AeroNal</label><input type="number" id="f_AeroNal" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>AeroInt</label><input type="number" id="f_AeroInt" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Metro</label><input type="number" id="f_Metro" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>EdAdmin</label><input type="number" id="f_EdAdmin" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Infraest</label><input type="number" id="f_Infraest" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>EvacCity</label><input type="number" id="f_EvacCity" max="1" min="" placeholder="1=Aplica"></div>
                <div class="form-group"><label>Otros</label><input type="number" id="f_Otros" max="1" min="" placeholder="1=Aplica"></div>
                </div>
            
            <button type="submit" class="btn btn-add">‚ûï Agregar a la Lista</button>
        </form>

        <hr style="margin: 30px 0;">

        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>3. Revisar Lista Actual (<span id="count">0</span> productos)</h3>
            <button onclick="downloadCSV()" class="btn btn-download">üíæ Descargar CSV Actualizado</button>
        </div>
        
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr id="tableHeaders"></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let globalData = [];
    let headers = [];

    // Array de nombres cortos para las columnas (usados en la tabla de vista previa)
    const shortHeaders = [
        'ID', 'Cat', 'Prod', 'Foto', 'Marca', 'Modelo', 'Desc', 'Uso', 'EVAC', 
        'Acc', 'Power', 'Tapa', 'Caja', 'HomeOf', 'Huddle', 'Juntas', 'Audit', 
        'Multi', 'Congr', 'Conv', 'Rest', 'RstBar', 'BarLoung', 'BarMusic', 'Disco', 
        'Teatro', 'Concert', 'Portatil', 'Hi-End', 'HomeTh', 'Apto', 'Casa', 'Tienda', 
        'Market', 'Mall', 'CenCom', 'Hotel', 'Resort', 'Museo', 'Parque', 'EduDist', 
        'Salon', 'Escuela', 'Colegio', 'Campus', 'Bibilotec', 'Capilla', 'Iglesia', 
        'Basilica', 'CasaOra', 'centroOra', 'Gym', 'Coliseo', 'Estadio', 'Consult', 
        'Clinica', 'Hospital', 'Bodega', 'Fabrica', 'Complex', 'EdificioOf', 'AeroReg', 
        'AeroNal', 'AeroInt', 'Metro', 'EdAdmin', 'Infraest', 'EvacCity', 'Otros'
    ];

    // IDs de los nuevos campos de proyecto (Columna 14 en adelante)
    const projectFieldIDs = [
        'f_HomeOf', 'f_Huddle', 'f_Juntas', 'f_Audit', 'f_Multi', 'f_Congr', 'f_Conv', 'f_Rest', 'f_RstBar', 'f_BarLoung', 'f_BarMusic', 
        'f_Disco', 'f_Teatro', 'f_Concert', 'f_Portatil', 'f_HiEnd', 'f_HomeTh', 'f_Apto', 'f_Casa', 'f_Tienda', 'f_Market', 'f_Mall', 
        'f_CenCom', 'f_Hotel', 'f_Resort', 'f_Museo', 'f_Parque', 'f_EduDist', 'f_Salon', 'f_Escuela', 'f_Colegio', 'f_Campus', 'f_Bibilotec', 
        'f_Capilla', 'f_Iglesia', 'f_Basilica', 'f_CasaOra', 'f_centroOra', 'f_Gym', 'f_Coliseo', 'f_Estadio', 'f_Consult', 'f_Clinica', 
        'f_Hospital', 'f_Bodega', 'f_Fabrica', 'f_Complex', 'f_EdificioOf', 'f_AeroReg', 'f_AeroNal', 'f_AeroInt', 'f_Metro', 'f_EdAdmin', 
        'f_Infraest', 'f_EvacCity', 'f_Otros'
    ];


    document.getElementById('csvFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        Papa.parse(file, {
            complete: function(results) {
                // Guardamos todo crudo para no romper la estructura de doble encabezado
                globalData = results.data;
                renderTable();
                document.getElementById('workspace').style.display = 'block';
            }
        });
    });

    // Nueva funci√≥n para duplicar una fila
    function duplicateRow(index) {
        const dataIndex = index + 2; 
        
        // Creamos una copia profunda de la fila (para que no sea la misma referencia)
        const newRow = JSON.parse(JSON.stringify(globalData[dataIndex]));

        // Insertamos la nueva fila justo despu√©s de la original
        globalData.splice(dataIndex + 1, 0, newRow);
        
        renderTable();
        alert('Fila duplicada. Recuerda cambiar el ID √önico para evitar confusiones.');
    }

    // Funci√≥n para eliminar una fila
    function deleteRow(index) {
        const dataIndex = index + 2; 
        if(confirm('¬øBorrar esta fila?')) {
            globalData.splice(dataIndex, 1);
            renderTable();
        }
    }

    function renderTable() {
        const tableHead = document.getElementById('tableHeaders');
        const tableBody = document.getElementById('tableBody');
        tableHead.innerHTML = '';
        tableBody.innerHTML = '';

        if (globalData.length === 0) return;

        // --- Renderizar Encabezados Personalizados ---
        const numColumns = globalData.length > 2 && globalData[2].length > 0 ? globalData[2].length : 0;
        
        for (let i = 0; i < numColumns; i++) {
            const th = document.createElement('th');
            th.textContent = shortHeaders[i] || `Col ${i + 1}`; 
            tableHead.appendChild(th);
        }
        
        const thDel = document.createElement('th');
        thDel.textContent = "Acci√≥n";
        tableHead.appendChild(thDel);
        // ---------------------------------------------


        // Renderizar Filas de Datos (Saltamos las 2 primeras que son headers en tu archivo original)
        for (let i = 0; i < globalData.length - 2; i++) {
            const dataIndex = i + 2; // El √≠ndice real en globalData
            const row = globalData[dataIndex];
            if(row.length < 2) continue; 

            const tr = document.createElement('tr');
            row.forEach((cell, cellIndex) => {
                if (cellIndex >= numColumns) return; 
                
                const td = document.createElement('td');
                td.contentEditable = true; 
                td.textContent = cell;
                
                td.addEventListener('blur', function() {
                    globalData[dataIndex][cellIndex] = this.textContent;
                });
                tr.appendChild(td);
            });

            // Botones Duplicar y Borrar
            const tdDel = document.createElement('td');
            
            // Bot√≥n Duplicar
            const btnDup = document.createElement('button');
            btnDup.textContent = "üìÑ";
            btnDup.className = "action-btn duplicate-btn";
            btnDup.onclick = function() {
                duplicateRow(i); 
            };
            tdDel.appendChild(btnDup);
            
            // Bot√≥n Borrar
            const btnDel = document.createElement('button');
            btnDel.textContent = "üóëÔ∏è";
            btnDel.className = "action-btn delete-btn";
            btnDel.onclick = function() {
                deleteRow(i); 
            };
            tdDel.appendChild(btnDel);
            
            tr.appendChild(tdDel);
            tableBody.appendChild(tr);
        }
        document.getElementById('count').textContent = globalData.length - 2;
    }

    // AGREGAR NUEVO PRODUCTO
    document.getElementById('addForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Recolecci√≥n de las primeras 13 columnas (Detalles B√°sicos)
        const newItem = [
            document.getElementById('id').value,
            document.getElementById('cat1').value, 
            document.getElementById('cat2').value, 
            document.getElementById('img').value,
            document.getElementById('marca').value,
            document.getElementById('modelo').value,
            document.getElementById('desc').value,
            document.getElementById('uso').value,
            document.getElementById('evac').value,
            document.getElementById('accesorio').value,
            document.getElementById('power').value,
            document.getElementById('tapa').value,
            document.getElementById('caja').value
        ];
        
        // Recolecci√≥n de las siguientes 56 columnas (Aplicabilidad por Proyecto)
        projectFieldIDs.forEach(fieldID => {
            // Recolecta el valor. Si est√° vac√≠o (no aplica), se env√≠a ""
            let value = document.getElementById(fieldID).value;
            newItem.push(value);
        });

        // Aseguramos que el nuevo item tenga el mismo largo que las filas existentes para no romper el CSV
        // Esto es un seguro en caso de que el CSV tenga m√°s columnas que las 69 que manejamos aqu√≠.
        const expectedLength = globalData.length > 0 ? globalData[0].length : newItem.length; 
        while(newItem.length < expectedLength) {
            newItem.push("");
        }

        globalData.push(newItem);
        renderTable();
        
        // Limpiar formulario
        this.reset();
        alert('Producto agregado al final de la lista. Recuerda que debes reordenarlo manualmente en Google Sheets.');
    });

    function downloadCSV() {
        const csv = Papa.unparse(globalData);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", "productos_actualizados.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>
</html>
