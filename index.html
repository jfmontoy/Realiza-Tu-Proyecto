<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realiza Tu Proyecto - Consultor de Soluciones Audiovisuales</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f8; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        
        /* Controles de Filtro */
        .controls { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 30px; padding: 20px; background: #eef2f5; border-radius: 8px; }
        .control-group { flex: 1; min-width: 250px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: #555; }
        select { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; }
        
        .results-info { margin-bottom: 15px; font-style: italic; color: #666; }
        
        /* Grid de Productos */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px; } 
        
        .product-card { border: 1px solid #e1e1e1; border-radius: 8px; overflow: hidden; background: white; transition: transform 0.2s; display: flex; flex-direction: column; position: relative; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .img-container { height: 180px; background: #fafafa; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #eee; padding: 10px; }
        .img-container img { max-height: 100%; max-width: 100%; object-fit: contain; }
        .no-img { color: #ccc; font-size: 14px; }
        
        .card-body { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .brand { font-size: 12px; font-weight: bold; color: #3498db; text-transform: uppercase; letter-spacing: 1px; }
        .model { font-size: 18px; font-weight: bold; margin: 5px 0; color: #2c3e50; }
        .type { font-size: 13px; color: #7f8c8d; background: #ecf0f1; display: inline-block; padding: 2px 8px; border-radius: 12px; margin-bottom: 10px; width: fit-content;}
        .desc { font-size: 14px; color: #555; line-height: 1.4; margin-bottom: 10px; flex-grow: 1; }
        .usage { font-size: 12px; color: #e67e22; border-top: 1px solid #eee; padding-top: 10px; margin-top: auto; margin-bottom: 8px;}

        /* Selección de productos */
        .selection-box { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            z-index: 10;
        }
        .select-label {
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 12px;
            font-weight: bold;
            color: #34495e;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            transition: background 0.2s;
        }
        .select-label input[type="checkbox"] { margin-right: 5px; }

        /* Area de Resumen de Lista */
        #listSummary {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #listSummary p { margin: 0; font-weight: bold; color: #2c3e50; }
        .send-button {
            background-color: #3498db; 
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        .send-button:hover { background-color: #2980b9; }
        .send-button:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        /* Formulario de Contacto */
        #emailForm {
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fdfdfd;
            margin-top: 20px;
            margin-bottom: 40px;
        }
        #emailForm input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .hidden { display: none; }

        /* Otros estilos */
        .evac-badge { background-color: #e74c3c; color: white; padding: 3px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; display: inline-block; margin-bottom: 5px; text-transform: uppercase; }
        .requirements-box { background-color: #f8f9fa; border: 1px solid #eee; border-radius: 4px; padding: 8px; font-size: 12px; color: #333; margin-top: 5px; }
        .req-item { margin-bottom: 4px; line-height: 1.3; }
        .req-label { font-weight: bold; color: #555; margin-right: 4px; }
        .main-logo { display: block; margin: 0 auto 10px auto; max-width: 250px; }
        
        /* Estilos para el reporte de impresión */
        @media print {
            body * { visibility: hidden; }
            #reportContainer, #reportContainer * { visibility: visible; }
            #reportContainer { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; box-shadow: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <img src="img/Logo A-INT 1000x1000.png" alt="Logo" class="main-logo">
    <h1>Realiza tu proyecto - Buscador de soluciones AV</h1>
    
    <p id="fileName" style="text-align: center; font-size: 12px; margin-top: 5px; color: #777;">Cargando datos automáticamente...</p>

    <div class="controls">
        <div class="control-group">
            <label for="categorySelect">1. Tipo General de Proyecto</label>
            <select id="categorySelect" disabled>
                <option value="">-- Seleccione una Categoría --</option>
            </select>
        </div>

        <div class="control-group">
            <label for="subcategorySelect">2. Espacio Específico</label>
            <select id="subcategorySelect" disabled>
                <option value="">-- Primero seleccione Categoría --</option>
            </select>
        </div>
    </div>

    <div id="resultsCount" class="results-info"></div>

    <div id="productsGrid" class="products-grid"></div>

    <div id="listSummary">
        <p>Productos seleccionados: <span id="selectedCount">0</span></p>
        <button id="sendListButton" class="send-button" disabled>Descargar / Imprimir Listado</button>
    </div>

    <div id="emailForm" class="hidden">
        <h3>Datos de Contacto (Para su reporte)</h3>
        <form id="contactForm">
            <label>Nombre y Apellido</label>
            <input type="text" id="nombreCompleto" placeholder="Ej: Juan Pérez" required>

            <label>Celular</label>
            <input type="tel" id="celular" placeholder="Ej: +57 300 123 4567" required>

            <label>Compañía</label>
            <input type="text" id="compania" placeholder="Ej: Mi Empresa S.A.S." required>

            <button type="submit" id="submitReportButton" class="send-button">Generar Reporte PDF/Imprimir</button>
        </form>
        <div id="formMessage" class="form-message hidden"></div>
    </div>
</div>

<script>
    // --- VARIABLES DE CONFIGURACIÓN FÁCIL (¡ATENCIÓN! ESTA ES LA ÚNICA LÍNEA QUE DEBES CAMBIAR) ---
    // Pega la URL de "Publicar en la web" de Google Sheets que termina en 'output=csv'.
    const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/16RaFL-Sz1SFYDHtKAK20R9tmr67lI0qvEM0W6ABUUls/edit?gid=1686983453#gid=1686983453'; 
    const IMAGE_BASE_URL = 'img/';
    
    // --- VARIABLES GLOBALES ---
    let globalData = [];
    let headersRow1 = [];
    let headersRow2 = [];
    let hierarchy = {};
    const START_INDEX = 14; 
    // Ahora el delimitador se leerá automáticamente desde la configuración de Google Sheets
    const CSV_DELIMITER = ","; // CAMBIO CLAVE: Google Sheets exporta por defecto con coma (,)
    // Si tu hoja de Google Sheets está en español y publica con punto y coma, usa ";". 
    // El ejemplo de URL arriba usa coma, por eso lo ajustamos.

    let selectedProducts = new Map(); 

    // --- INICIALIZACIÓN ---
    window.onload = function() {
        // CAMBIO: Ahora carga desde la URL de Google Sheets
        loadDataAutomatically(GOOGLE_SHEET_URL);
        document.getElementById('categorySelect').addEventListener('change', handleCategoryChange);
        document.getElementById('subcategorySelect').addEventListener('change', handleSubcategoryChange);
        document.getElementById('sendListButton').addEventListener('click', toggleEmailForm);
        document.getElementById('contactForm').addEventListener('submit', handleReportGenerate); 
        updateSummary();
    };

    // --- FUNCIÓN DE CARGA AUTOMÁTICA MODIFICADA ---
    function loadDataAutomatically(path) {
        Papa.parse(path, {
            download: true,
            delimiter: CSV_DELIMITER, // Usamos la coma (,) por defecto de Google Sheets
            skipEmptyLines: true,
            complete: function(results) {
                const data = results.data;
                if (data.length < 3) {
                    document.getElementById('fileName').textContent = "Error: Hoja de Google vacía o mal formada.";
                    return;
                }
                document.getElementById('fileName').textContent = `✅ Datos cargados automáticamente desde Google Sheets.`;
                processData(data);
            },
            error: function(err, file, inputElem, reason) {
                console.error("Error al cargar la hoja de Google:", reason);
                document.getElementById('fileName').textContent = "❌ ERROR: No se pudo cargar la Hoja de Google. Revise la URL y el permiso de 'Publicar en la web'.";
            }
        });
    }

    // --- EL RESTO DE FUNCIONES SE MANTIENEN IGUAL ---

    function toggleSelection(productID, productData) {
        const button = document.getElementById('select-' + productID);
        
        if (selectedProducts.has(productID)) {
            selectedProducts.delete(productID);
            button.checked = false;
        } else {
            selectedProducts.set(productID, productData);
            button.checked = true;
        }
        updateSummary();
        document.getElementById('emailForm').classList.add('hidden');
    }

    function updateSummary() {
        const count = selectedProducts.size;
        document.getElementById('selectedCount').textContent = count;
        const button = document.getElementById('sendListButton');
        const form = document.getElementById('emailForm');

        if (count > 0) {
            button.disabled = false;
        } else {
            button.disabled = true;
            form.classList.add('hidden');
        }
    }

    function toggleEmailForm() {
        document.getElementById('emailForm').classList.toggle('hidden');
    }

    function generateReportHtml(payload) {
        const products = payload.products;
        
        let tableHtml = `
            <style>
                body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                .report-header { background-color: #2c3e50; color: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
                .report-header h1 { margin: 0; font-size: 24px; }
                .contact-info { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
                .contact-info p { margin: 5px 0; font-size: 14px; }
                table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                th, td { border: 1px solid #ccc; padding: 10px; text-align: left; font-size: 13px; }
                th { background-color: #f4f6f8; color: #333; }
                h2 { color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-top: 30px; }
            </style>
            
            <div id="reportContainer">
                <div class="report-header">
                    <h1>Reporte de Soluciones AV Seleccionadas</h1>
                    <p>Generado el: ${new Date().toLocaleDateString('es-CO')}</p>
                </div>

                <div class="contact-info">
                    <h2>Datos de Contacto</h2>
                    <p><strong>Nombre:</strong> ${payload.senderName}</p>
                    <p><strong>Compañía:</strong> ${payload.senderCompany}</p>
                    <p><strong>Celular:</strong> ${payload.senderPhone}</p>
                </div>

                <h2>Listado de Productos (${products.length} Seleccionados)</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Marca</th>
                            <th>Modelo</th>
                            <th>Tipo</th>
                            <th>Descripción</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        products.forEach(p => {
            tableHtml += `
                <tr>
                    <td>${p.marca}</td>
                    <td>${p.modelo}</td>
                    <td>${p.subtipo}</td>
                    <td>${p.descripcion}</td>
                </tr>
            `;
        });

        tableHtml += `</tbody></table></div>`;
        return tableHtml;
    }


    async function handleReportGenerate(event) {
        event.preventDefault();

        const form = event.target;
        
        if (selectedProducts.size === 0) {
             alert('Por favor, selecciona al menos un producto antes de generar el reporte.');
             return;
        }

        const payload = {
            senderName: form.nombreCompleto.value,
            senderPhone: form.celular.value,
            senderCompany: form.compania.value,
            products: Array.from(selectedProducts.values())
        };
        
        const reportHtml = generateReportHtml(payload);
        
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write(reportHtml);
        printWindow.document.close(); 
        
        printWindow.onload = function() {
            printWindow.print(); 
        };
    }
    
    function processData(rows) {
        headersRow1 = rows[0]; 
        headersRow2 = rows[1];
        globalData = rows.slice(2);

        hierarchy = {};
        let currentCategory = "";

        for (let i = START_INDEX; i < headersRow1.length; i++) {
            let cat = headersRow1[i];
            
            if (cat && cat.trim() !== "") {
                currentCategory = cat.trim();
                hierarchy[currentCategory] = [];
            }

            if (currentCategory && headersRow2[i] && headersRow2[i].trim() !== "") {
                hierarchy[currentCategory].push({
                    index: i,
                    name: headersRow2[i].trim()
                });
            }
        }
        
        const catSelect = document.getElementById('categorySelect');
        catSelect.innerHTML = '<option value="">-- Seleccione una Categoría --</option>';
        catSelect.disabled = false;

        Object.keys(hierarchy).forEach(catName => {
            const option = document.createElement('option');
            option.value = catName;
            option.textContent = catName;
            catSelect.appendChild(option);
        });
        
        document.getElementById('subcategorySelect').disabled = true;
    }

    function handleCategoryChange() {
        const catName = this.value;
        const subCatSelect = document.getElementById('subcategorySelect');
        subCatSelect.innerHTML = '<option value="">-- Seleccione Espacio --</option>';
        document.getElementById('productsGrid').innerHTML = '';
        document.getElementById('resultsCount').innerHTML = '';

        selectedProducts.clear();
        updateSummary();
        document.getElementById('emailForm').classList.add('hidden');


        if (!catName) {
            subCatSelect.disabled = true;
            return;
        }

        const subCategories = hierarchy[catName];
        if (subCategories) {
            subCategories.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.index;
                option.textContent = sub.name;
                subCatSelect.appendChild(option);
            });
            subCatSelect.disabled = false;
        }
    }

    function handleSubcategoryChange() {
        const columnIndex = this.value;
        if (!columnIndex) return;
        
        selectedProducts.clear();
        updateSummary();
        document.getElementById('emailForm').classList.add('hidden');

        filterProducts(parseInt(columnIndex));
    }

    function filterProducts(colIndex) {
        const grid = document.getElementById('productsGrid');
        grid.innerHTML = '';
        
        const filteredProducts = globalData.filter(row => {
            return row[colIndex] && row[colIndex].trim() === '1';
        });

        document.getElementById('resultsCount').textContent = `Se encontraron ${filteredProducts.length} productos para este espacio.`;

        if (filteredProducts.length === 0) {
            grid.innerHTML = '<p>No hay productos marcados para esta selección.</p>';
            return;
        }

        filteredProducts.forEach(product => {
            // Mapeo de columnas basado en el CSV (Indices empiezan en 0):
            // *** NOTA: El ID está en product[0] si eliminaste la Columna A ***
            const id = product[0] || ""; // Asumiendo que ID es ahora la primera columna (índice 0)
            const tipo = product[1] || "";
            const subtipo = product[2] || "";
            const fotoPath = product[3] || ""; 
            const marca = product[4] || "";
            const modelo = product[5] || "";
            const descripcion = product[6] || "";
            const uso = product[7] || "";
            const evacStatus = product[8] || "";
            const accesorio = product[9] || "";
            const powerSupply = product[10] || "";
            const tapa = product[11] || "";
            const caja = product[12] || "";
            // El resto de columnas se desplazan dos posiciones hacia la izquierda.
            const newStartIndex = 13; 
            const finalColIndex = colIndex - 1; // Ajustamos el índice del filtro

            let cleanPhotoPath = fotoPath.split('/').pop();
            let imgSrc = cleanPhotoPath ? IMAGE_BASE_URL + cleanPhotoPath : '';

            const card = document.createElement('div');
            card.className = 'product-card';
            
            let imgHtml = imgSrc 
                ? `<img src="${imgSrc}" alt="${modelo}" onerror="this.onerror=null;this.parentElement.innerHTML='<span class=\\'no-img\\'>Sin imagen</span>';">` 
                : `<span class="no-img">Sin imagen</span>`;

            let evacHtml = (evacStatus.trim() === '1') 
                ? `<div class="evac-badge">⚠️ EVAC Certificado</div>` 
                : '';

            let requirementsHtml = '';
            
            if (accesorio || powerSupply || tapa || caja) {
                requirementsHtml += `<div class="requirements-box">`;
                if (accesorio) requirementsHtml += `<div class="req-item"><span class="req-label">Requiere Accesorio:</span>${accesorio}</div>`;
                if (powerSupply) requirementsHtml += `<div class="req-item"><span class="req-label">Power Supply:</span>${powerSupply}</div>`;
                if (tapa) requirementsHtml += `<div class="req-item"><span class="req-label">Requiere Tapa:</span>${tapa}</div>`;
                if (caja) requirementsHtml += `<div class="req-item"><span class="req-label">Requiere Caja:</span>${caja}</div>`;
                requirementsHtml += `</div>`;
            }
            
            const productData = { id, marca, modelo, subtipo, descripcion, imgSrc };

            const isSelected = selectedProducts.has(id);
            
            card.innerHTML = `
                <div class="selection-box">
                    <label class="select-label">
                        <input 
                            type="checkbox" 
                            id="select-${id}" 
                            ${isSelected ? 'checked' : ''} 
                            onclick="toggleSelection('${id}', ${JSON.stringify(productData).replace(/"/g, "'")})"
                        >
                        Seleccionar
                    </label>
                </div>
                <div class="img-container">
                    ${imgHtml}
                </div>
                <div class="card-body">
                    <div class="brand">${marca}</div>
                    <div class="model">${modelo}</div>
                    ${evacHtml}
                    <div class="type">${subtipo}</div>
                    <div class="desc">${descripcion}</div>
                    ${uso ? `<div class="usage"><strong>¿Cuándo usar?</strong> ${uso}</div>` : ''}
                    ${requirementsHtml}
                </div>
            `;
            grid.appendChild(card);
        });
    }
</script>

</body>
</html>
